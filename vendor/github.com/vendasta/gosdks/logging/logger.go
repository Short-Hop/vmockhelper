package logging

import (
	"context"
)

// Logger provides the methods for logging.
type Logger interface {
	request(ctx context.Context, r *requestData, stream Stream)
	Debugf(ctx context.Context, f string, a ...interface{})
	Infof(ctx context.Context, f string, a ...interface{})
	Warningf(ctx context.Context, f string, a ...interface{})
	Errorf(ctx context.Context, f string, a ...interface{})
	Criticalf(ctx context.Context, f string, a ...interface{})
	Alertf(ctx context.Context, f string, a ...interface{})
	Emergencyf(ctx context.Context, f string, a ...interface{})
	StackTrace(ctx context.Context, f string, a ...interface{})
	Tag(ctx context.Context, key, value string) Logger
	//RequestID will return a new ID each time that it is called
	RequestID() string
	// ActiveRequestId will return the ID of the request that is currently being processed.
	// Background work that is not done in the context of a monitored request will return an empty string
	// The requestID is specific to a single API/pubsub call. See ActiveTraceId for an ID that spans multiple microservices.
	//
	// You may include this id in error reports and then find the log messages by searching for
	//     labels.request_ID="xxx"
	ActiveRequestId(ctx context.Context) string
	// ActiveTraceId will return the ID that is used to group all log messages generated by this and other microservices in
	// response to the same external request.
	//
	// Note: This ID may change if trace.StartSpan is called later
	ActiveTraceId(ctx context.Context) string
}

var loggerInstance Logger = &stderrLogger{config: &config{}}

// Stream enumerates the gcloud logging streams
type Stream string

const (
	// Request is the gcloud request log stream
	Request Stream = "request"
	// Pubsub is the gcloud pubsub log stream
	Pubsub Stream = "pubsub"
	// Taskqueue is the gcloud task log stream
	Taskqueue Stream = "taskqueue"
	// Odin is the odin log stream
	Odin Stream = "odin"
	// Goroutine is for goroutines running in the background of the pod
	Goroutine Stream = "goroutine"
)

// GetLogger returns the current Logger instance.
// TODO: Remove this function when migration is done.
func GetLogger() Logger {
	return loggerInstance
}

func logRequest(ctx context.Context, r *requestData, stream Stream) {
	GetLogger().request(ctx, r, stream)
}

// Debugf emits a debug log
func Debugf(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Debugf(ctx, f, a...)
}

// Infof emits a info log
func Infof(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Infof(ctx, f, a...)
}

// Warningf emits a warning log
func Warningf(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Warningf(ctx, f, a...)
}

// Errorf emits an error log
func Errorf(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Errorf(ctx, f, a...)
}

// Criticalf emits a critical log
func Criticalf(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Criticalf(ctx, f, a...)
}

// Alertf emits an alert log
func Alertf(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Alertf(ctx, f, a...)
}

// Emergencyf emits an emergency log
func Emergencyf(ctx context.Context, f string, a ...interface{}) {
	GetLogger().Emergencyf(ctx, f, a...)
}

// StackTrace logs a message with a stack trace to the current location
func StackTrace(ctx context.Context, f string, a ...interface{}) {
	GetLogger().StackTrace(ctx, f, a...)
}

// Tag sets a tag on the request
func Tag(ctx context.Context, key, value string) Logger {
	return GetLogger().Tag(ctx, key, value)
}

// ActiveRequestId will return the ID of the request that is currently being processed.
// Background work that is not done in the context of a monitored request will return an empty string
// The requestID is specific to a single API/pubsub call. See ActiveTraceId for an ID that spans multiple microservices.
//
// You may include this id in error reports and then find the log messages by searching for
//     labels.request_ID="xxx"
func ActiveRequestId(ctx context.Context) string {
	return GetLogger().ActiveRequestId(ctx)
}

// ActiveTraceId will return the ID that is used to group all log messages generated by this and other microservices in
// response to the same external request.
func ActiveTraceId(ctx context.Context) string {
	return GetLogger().ActiveTraceId(ctx)
}
